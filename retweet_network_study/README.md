# Retweet Network Study

## Directories

### Data

Two datasets -- test_users.csv and test_rt.csv -- are required to run the unit tests on the simulations (included in the repo), and users_ratings.csv and rt_network.csv are required to run the full simulations.

### Simulations
The simulations modules can be found within the src/acrophily_sims directory. The data_prep.py module contains the TwitterDataProcessor class that loads and processes the data used to run the simulation. The sims.py module contains the three classes (AcrophilySim, MeanAbsDiffSim, ProbDiffSim) that run the simulations. The cli.py module contains the command-line interface as well as the main function to run the specified simulation for a given political affiliation/subset of users, which is run in the __main__.py script.

### Process Data

This directory contains the process_data.py script as well as the convert_to_long_format.Rmd script that processes data generated by the simulations. The former script merges and aggregates simulations run on fractions of the dataset at a time, while the convert_to_long_format R Markdown script generates datasets that can be easily analyzed and visualized using R libraries such as ggplot2.

### Analysis

Scripts containing visualization or evaluation of the datasets can be found here.

### Figures

Figures saved from visualization scripts should be placed here.

### Tests

Unit tests for the simulation code are found here.

## General process description.

Getting the simulation running requires processing multiple files at a certain order. The goal of this section is to explain what is being run at each stage and to describe the output of each code.

NOTE: All Python files should be run via the command line from the retweet_network_study main directory.

**1** First run the simulations that are found in the src/acrophily_sims directory. These can be found in the sims.py file. These simulations will be run via the command terminal following the process described below. This will generate multiple files for each specified fraction of the dataset and for each political affiliation. The files will contain a single row for each user within each fraction that will be merged and processed after the simulation has been completed for all fractions of data.

**2** Next run the process_sim_data.py file with proper command line arguments to process data files generated after running the simulation. This file can be found in the process_data folder. Running the script will produce a single file per political affiliation for each simulation that contains aggregated data by retweet threshold (mean_abs_diff, acrophily simulations) or a single acrophily coefficient per user (prob_diff simulation). 

**3** Next run the R Markdown file convert_to_long_retweet_networks.Rmd found in the process_data directory. This will merge the separate political affiliation files together and convert to long format for analysis.

**4** Finally, we can plot the results by running the plot_acrophily_simulations.Rmd file found in the analysis directory.

## Simulations

Where arg1, arg2... represent the command line arguments defined above.

### Setup

To be able to run any of the three simulations, first make sure that python, pip, and pipenv are all installed on your computer. Then, simply run the following commands from the retweet_network_study directory in your command terminal:
```
pipenv install
```

To then activate the environment, run:
```
pipenv shell
```

### Running simulations

With the environment activated, the main command from the command line to run any of the simulations is as follows:
```
python -m acrophily_sims
```

You may then pass in the following additional arguments:
```
'-s' (or '--sim_type'): The type of simulation ('acrophily', 'mean_abs_diff', 'prob_diff')
'-p' (or '--poli_affil'): The political affiliation on which you run the simulation ('left' or 'right')
'-f' (or '--frac_data'): Indicates whether to run simulation on fraction of data (True or False)
'fs' (or '--frac_start'): Indicates the starting fraction of data (float within range: [0.0, 1.0))
'fe' (or '--frac_end'): Indicates the end fraction of data (float within range: (0.0, 1.0])
```

As an example, if you wish to run the mean absolute difference simulation on the first ten percent of right-leaning participants, you pass the following argument from the command line in the retweet_network_study directory after installing and creating your pipenv environment:
```
python -m acrophily_sims -s 'mean_abs_diff' -p 'right' -f True -fs 0.0 -fe 0.1
```

### Running With Docker

You can alternatively run the simulations using Docker by building and running a Docker image using our Dockerfile. To build the Docker image, run the following from the main directory:

```
docker build . -t sim_image
```

You can then run the application through the Docker image with the following command:

```
docker run --rm sim_image arg1 arg2
```
where arg1, arg2... represent the command line arguments defined above.

## Processing Simulation Data

Once the simulations have been run, you can run the following command to generate single aggregated files for each political affiliation and for each simulation:

```
python3 process_data/process_sim_data.py --data_folder_path --sim_type -- poli_affil
```

Here, the sim_type and poli_affil arguments are the same as above, and the data_folder_path argument is as follows:

```
'-d' (or '--data_path'): Pathway to the data files to process (default: 'data')

'-a', (or '--agg'): Whether to aggregate individual level data

'-s' (or '--sim_type'): The type of simulation ('acrophily', 'mean_abs_diff', 'prob_diff')
'-p' (or '--poli_affil'): The political affiliation on which you run the simulation ('left' or 'right')
```

To then convert aggregated data to long format, run the R Markdown script convert_to_long_retweet_networks.Rmd specifying the proper data paths at the beginning of the script.


## Visualizing Results

Run the plots_acrophily_simulations.Rmd script to produce visualizations of the results of each simulation.

## Running Bayesian Model

To analyze the individual level acrophily simulation data using a Bayesian model, run the following from the command line:

```
pipenv run python3 analysis/bayes_model.py --data_path --poli_affil
```

where --data_path (or -d) and --poli_affil (-p) represent the path to the data and the political affiliation you wish to run the Bayesian model on (left/right).
